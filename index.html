<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Игра в Имитацию: Кто же ты?</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* БАЗА КОР */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: radial-gradient(circle at top, #1a2a3a 0, #05070b 55%, #000000 100%);
      background-size: 200% 200%;
      animation: bg-shift 28s ease-in-out infinite alternate;
      color: #00ff9c;
      font-family: "Courier New", monospace;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      position: relative;
      overflow: auto;
    }

    /* Темы цвета */
    body.theme-default {
      filter: none;
    }

    body.theme-violet {
      filter: hue-rotate(60deg) saturate(1.05);
    }

    /* Янтарная — спокойная, без неона */
    body.theme-amber {
      filter: saturate(0.8) brightness(0.9);
    }

    body.theme-amber .bg-lines,
    body.theme-amber .bg-orbit {
      opacity: 0.18;
    }

    body.theme-amber #game-root {
      border-color: #e0b36a;
      background: rgba(12, 9, 4, 0.96);
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.9);
      animation: none;
    }

    body.theme-amber #logo {
      color: #f5d7a3;
      text-shadow: none;
      animation: none;
    }

    body.theme-amber .choice-btn {
      border-color: #e0b36a88;
      background:
        linear-gradient(90deg, rgba(24, 17, 6, 0.96), rgba(16, 10, 2, 0.96));
    }

    body.theme-amber .choice-btn:hover {
      box-shadow: 0 0 6px #000000aa;
      border-color: #f5d7a3cc;
    }

    body.theme-amber #alignment-fill-human {
      background: linear-gradient(90deg, #f5d7a3, transparent);
    }

    body.theme-amber #alignment-fill-tech {
      background: linear-gradient(270deg, #c9a86a, transparent);
    }

    body.theme-amber #theme-box {
      color: #e0c197;
    }

    body.theme-amber .theme-chip {
      border-color: #b4935a55;
      color: #f5d7a3dd;
    }

    body.theme-amber .theme-chip.active {
      box-shadow: none;
    }

    body.theme-amber #ai-comment {
      color: #f0d19b88;
      text-shadow: 0 0 3px #000;
    }

    @keyframes bg-shift {
      0% { background-position: 0% 0%; }
      100% { background-position: 100% 100%; }
    }

    /* Фоновая сетка + орбиты */
    .bg-lines {
      position: fixed;
      inset: -20px;
      background-image:
        linear-gradient(
          rgba(0, 255, 156, 0.08) 1px,
          transparent 1px
        ),
        linear-gradient(
          90deg,
          rgba(0, 255, 156, 0.08) 1px,
          transparent 1px
        );
      background-size: 40px 40px, 40px 40px;
      opacity: 0.15;
      pointer-events: none;
      z-index: 0;
      mix-blend-mode: screen;
      animation: grid-move 20s linear infinite;
    }

    @keyframes grid-move {
      0% { transform: translate3d(0, 0, 0); }
      100% { transform: translate3d(-40px, -40px, 0); }
    }

    .bg-orbit {
      position: fixed;
      border-radius: 50%;
      border: 1px dashed rgba(0, 255, 156, 0.3);
      box-shadow: 0 0 16px rgba(0, 255, 156, 0.2);
      pointer-events: none;
      z-index: 0;
    }

    .orbit-1 {
      width: 60vw;
      height: 60vw;
      top: -20vw;
      right: -10vw;
      animation: orbit-spin 42s linear infinite;
    }

    .orbit-2 {
      width: 40vw;
      height: 40vw;
      bottom: -15vw;
      left: -5vw;
      animation: orbit-spin 55s linear infinite reverse;
    }

    .orbit-3 {
      width: 30vw;
      height: 30vw;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      animation: orbit-pulse 30s ease-in-out infinite;
      opacity: 0.2;
    }

    @keyframes orbit-spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @keyframes orbit-pulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.1); }
    }

    /* Глич-полосы по краям (усиливаются при тех-доминанте) */
    .edge-glitch {
      position: fixed;
      top: 0;
      bottom: 0;
      width: 22px;
      pointer-events: none;
      z-index: 3;
      opacity: 0;
      mix-blend-mode: screen;
      background:
        linear-gradient(
          to bottom,
          rgba(0, 255, 156, 0) 0%,
          rgba(0, 255, 156, 0.4) 30%,
          rgba(255, 0, 255, 0.4) 60%,
          rgba(0, 255, 156, 0) 100%
        );
      clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
      transform: translateZ(0);
    }

    .edge-glitch-left {
      left: 0;
    }

    .edge-glitch-right {
      right: 0;
    }

    body.glitch-strong .edge-glitch {
      opacity: 0.45;
      animation: edge-glitch-flicker 0.3s steps(2, start) infinite;
    }

    @keyframes edge-glitch-flicker {
      0% { transform: translateX(0); filter: hue-rotate(0deg); }
      50% { transform: translateX(2px); filter: hue-rotate(30deg); }
      100% { transform: translateX(-1px); filter: hue-rotate(-20deg); }
    }

    /* CRT плёнка */
    .crt {
      position: fixed;
      inset: 0;
      pointer-events: none;
      background:
        repeating-linear-gradient(
          rgba(0, 0, 0, 0.18),
          rgba(0, 0, 0, 0.18) 1px,
          rgba(0, 0, 0, 0.22) 2px
        );
      mix-blend-mode: multiply;
      opacity: 0.6;
      z-index: 5;
    }

    #game-root {
      position: relative;
      max-width: 960px;
      width: 100%;
      background: rgba(3, 8, 16, 0.94);
      border: 2px solid #00ff9c;
      box-shadow: 0 0 18px #00ff9c55;
      padding: 16px;
      overflow: hidden;
      z-index: 2;
      backdrop-filter: blur(2px);
    }

    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #00ff9c55;
      padding-bottom: 8px;
      margin-bottom: 8px;
      font-size: 12px;
    }

    #logo {
      font-weight: bold;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #7cfbff;
      text-shadow: 0 0 6px #00ff9caa;
      animation: logo-glow 3.5s ease-in-out infinite;
    }

    @keyframes logo-glow {
      0%, 100% { text-shadow: 0 0 4px #00ff9caa; }
      50% { text-shadow: 0 0 12px #7cfbffaa; }
    }

    #header-right {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #role-display {
      font-style: italic;
      color: #00ff9c;
      font-size: 11px;
      opacity: 0.9;
    }

    /* Кнопка иконка (музыка, закрыть и т.п.) */
    .icon-btn {
      border: 1px solid #00ff9c66;
      background: rgba(0, 0, 0, 0.7);
      color: #00ff9c;
      border-radius: 4px;
      font-size: 11px;
      padding: 3px 6px;
      cursor: pointer;
      box-shadow: 0 0 6px #00ff9c55;
      transition: background 0.15s, transform 0.07s, color 0.15s;
    }

    .icon-btn:hover {
      background: rgba(0, 255, 156, 0.18);
      box-shadow: 0 0 8px #00ff9c77;
      transform: translateY(-1px);
    }

    .icon-btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .icon-btn.on {
      color: #07130f;
      background: #00ff9c;
      box-shadow: 0 0 12px #00ff9caa;
    }

    /* Ачивки */
    #achievements-strip {
      display: flex;
      align-items: center;
      gap: 3px;
      margin-right: 4px;
    }

    .ach-icon {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid #00ff9c33;
      font-size: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.25;
      color: #00ff9c55;
      background: rgba(0, 0, 0, 0.5);
      cursor: default;
      box-shadow: none;
      transition: opacity 0.2s, border-color 0.2s, box-shadow 0.2s, transform 0.1s;
    }

    .ach-icon.unlocked {
      opacity: 1;
      color: #000;
      border-color: #7cfbffcc;
      background: radial-gradient(circle at 30% 20%, #ffffff, #00ff9c);
      box-shadow: 0 0 6px #00ff9c77;
      transform: translateY(-1px);
    }

    .ach-icon.unlocked:hover {
      box-shadow: 0 0 10px #7cfbff99;
    }

    #screen {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 12px;
    }

    @media (max-width: 720px) {
      #screen {
        grid-template-columns: 1fr;
      }

      #role-display {
        font-size: 11px;
      }

      #achievements-strip {
        display: none;
      }
    }

    #image-box {
      border: 1px solid #00ff9c55;
      min-height: 220px;
      background: radial-gradient(circle, #041018 0, #020509 70%);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }

    #image-box::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(
        120deg,
        transparent 0,
        rgba(0, 255, 156, 0.04) 40%,
        transparent 80%
      );
      mix-blend-mode: screen;
      pointer-events: none;
    }

    #image-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: saturate(1.15) contrast(1.1);
      transform: scale(1.02);
      opacity: 0;
      transition: opacity 0.4s ease-out;
    }

    #image-box img.show {
      opacity: 1;
    }

    #image-box .placeholder {
      font-size: 12px;
      color: #00ff9caa;
      text-align: center;
      padding: 8px;
    }

    #scene-box {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #scene-title {
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #7cfbff;
      font-size: 13px;
    }

    #scene-text {
      font-size: 14px;
      line-height: 1.5;
      min-height: 120px;
      white-space: pre-wrap;
    }

    #choices {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .choice-btn {
      background: transparent;
      border: 1px solid #00ff9caa;
      color: #00ff9c;
      padding: 8px 10px;
      text-align: left;
      font-size: 14px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: background 0.15s, transform 0.05s, box-shadow 0.15s;
    }

    .choice-btn::before {
      content: ">";
      margin-right: 6px;
      color: #7cfbff;
    }

    .choice-btn:hover {
      background: rgba(0, 255, 156, 0.08);
      box-shadow: 0 0 10px #00ff9c55;
      transform: translateY(-1px);
    }

    .choice-btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .choice-btn.selected {
      background: rgba(0, 255, 156, 0.18);
      box-shadow: 0 0 10px #00ff9c88;
    }

    /* Секретный вариант */
    .secret-choice {
      background: transparent;
      border: 1px dashed #7cfbffaa;
      color: #7cfbffdd;
      padding: 4px 8px;
      font-size: 11px;
      align-self: flex-start;
      opacity: 0.3;
      cursor: default;
      max-width: 70%;
    }

    .secret-choice::before {
      content: "?";
      margin-right: 6px;
      color: #7cfbff;
    }

    .secret-choice:not(:disabled) {
      cursor: pointer;
      opacity: 0.9;
      box-shadow: 0 0 8px #7cfbff55;
    }

    .secret-choice:not(:disabled):hover {
      background: rgba(124, 251, 255, 0.1);
    }

    #footer {
      margin-top: 8px;
      font-size: 11px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #00ff9c88;
    }

    #progress {
      font-family: inherit;
    }

    .blink {
      animation: blink 1s steps(2, start) infinite;
    }

    @keyframes blink {
      to {
        visibility: hidden;
      }
    }

    .glitch {
      position: relative;
      text-shadow: 1px 0 #ff00c1, -1px 0 #00eaff;
    }

    /* Панель уверенности */
    #confidence-panel {
      margin-top: 6px;
      font-size: 11px;
      border-top: 1px solid #00ff9c33;
      padding-top: 6px;
      display: none;
    }

    #confidence-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
    }

    #confidence-slider {
      width: 100%;
    }

    #alignment {
      margin-top: 4px;
      border: 1px solid #00ff9c44;
      height: 8px;
      width: 160px;
      display: flex;
      overflow: hidden;
    }

    #alignment-fill-human {
      background: linear-gradient(90deg, #00ff9c, transparent);
      width: 0%;
      transition: width 0.3s;
    }

    #alignment-fill-tech {
      background: linear-gradient(270deg, #ff00c1, transparent);
      width: 0%;
      transition: width 0.3s;
    }

    /* Комментарий ИИ (ломаем 4-ю стену: вне рамки игры) */
    #ai-comment {
      position: fixed;
      right: 12px;
      bottom: 16px;
      max-width: 260px;
      font-size: 11px;
      color: #7cfbffaa;
      background: rgba(0, 0, 0, 0.8);
      border: 1px solid #7cfbff55;
      padding: 6px 8px;
      border-radius: 4px;
      z-index: 10;
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none;
      white-space: pre-wrap;
      text-align: left;
    }

    .ai-comment-show {
      opacity: 1 !important;
      transform: translateY(0) !important;
      transition: opacity 0.3s, transform 0.3s;
    }

    /* Модалки результата, эпилога, мини-игры */
    #result-modal,
    #epilogue-modal,
    #minigame-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 800;
    }

    #result-modal.show,
    #epilogue-modal.show,
    #minigame-modal.show {
      display: flex;
    }

    #result-backdrop,
    #epilogue-backdrop,
    #minigame-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(2px);
    }

    #result-dialog,
    #epilogue-dialog,
    #minigame-dialog {
      position: relative;
      max-width: 520px;
      width: 90%;
      background: rgba(3, 8, 16, 0.97);
      border-radius: 8px;
      border: 1px solid #00ff9caa;
      box-shadow: 0 0 18px #00ff9c66;
      padding: 10px;
      z-index: 801;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 80vh;
    }

    #result-header,
    #epilogue-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: #7cfbff;
      border-bottom: 1px solid #00ff9c33;
      padding-bottom: 4px;
      margin-bottom: 4px;
    }

    #result-body,
    #epilogue-body {
      font-size: 12px;
      white-space: pre-wrap;
      overflow-y: auto;
      padding-right: 4px;
    }

    .epilogue-block {
      margin-bottom: 10px;
      border-bottom: 1px dashed #00ff9c33;
      padding-bottom: 6px;
    }

    .epilogue-block-title {
      font-weight: bold;
      color: #7cfbff;
      margin-bottom: 2px;
    }

    .epilogue-block-text {
      font-size: 12px;
      white-space: pre-wrap;
    }

    /* МИНИ-ИГРЫ */
    #minigame-dialog {
      max-width: 420px;
    }

    #minigame-title {
      font-size: 13px;
      color: #7cfbff;
      margin-bottom: 2px;
    }

    #minigame-text {
      font-size: 12px;
      white-space: pre-wrap;
      min-height: 60px;
    }

    #minigame-choices {
      display: none;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    #minigame-button {
      align-self: flex-end;
      font-size: 13px;
      padding: 6px 10px;
    }

    body.theme-amber #minigame-dialog {
      border-color: #e0b36a;
      box-shadow: 0 0 10px #000000aa;
      background: rgba(12, 9, 4, 0.97);
    }

    body.theme-amber #minigame-title {
      color: #f5d7a3;
    }

    /* Блок выбора темы */
    #theme-box {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 4px;
      color: #7cfbff;
    }

    .theme-chip {
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid #00ff9c66;
      background: rgba(0, 0, 0, 0.6);
      font-size: 11px;
      cursor: pointer;
      color: #00ff9ccc;
      transition: background 0.15s, box-shadow 0.15s, transform 0.07s;
    }

    .theme-chip:hover {
      background: rgba(0, 255, 156, 0.08);
      box-shadow: 0 0 8px #00ff9c55;
      transform: translateY(-1px);
    }

    .theme-chip.active {
      background: #00ff9c;
      color: #07130f;
      box-shadow: 0 0 10px #00ff9caa;
    }

    /* Форма игрока */
    .field {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-bottom: 6px;
      font-size: 12px;
    }

    .field label {
      color: #7cfbff;
    }

    .field input,
    .field select {
      background: #02070d;
      border: 1px solid #00ff9c55;
      color: #00ff9c;
      padding: 4px 6px;
      font-family: inherit;
      font-size: 12px;
      outline: none;
    }

    .field input:focus,
    .field select:focus {
      border-color: #7cfbffaa;
      box-shadow: 0 0 6px #7cfbff55;
    }

    body.theme-amber .field input,
    body.theme-amber .field select {
      background: #171007;
      border-color: #b4935a77;
      color: #f5d7a3;
    }

    body.theme-amber .field input:focus,
    body.theme-amber .field select:focus {
      border-color: #f5d7a3cc;
      box-shadow: 0 0 6px #000000aa;
    }
  </style>
</head>
<body class="theme-default">
  <!-- Неоновая сетка -->
  <div class="bg-lines"></div>
  <div class="bg-orbit orbit-1"></div>
  <div class="bg-orbit orbit-2"></div>
  <div class="bg-orbit orbit-3"></div>

  <!-- Глич-полосы по краям -->
  <div class="edge-glitch edge-glitch-left"></div>
  <div class="edge-glitch edge-glitch-right"></div>

  <div id="game-root">
    <div id="header">
      <div id="logo">IMI-SYS_01 • ИГРА В ИМИТАЦИЮ</div>
      <div id="header-right">
        <button id="music-toggle" class="icon-btn" aria-label="Музыка вкл/выкл">♪</button>
        <div id="achievements-strip"></div>
        <div id="role-display"></div>
      </div>
    </div>

    <div id="screen">
      <div id="image-box">
        <div class="placeholder">
          ЗОНА ВИЗУАЛИЗАЦИИ<br />
          (положи сюда файлы картинок в папку <code>images/</code>)
        </div>
      </div>
      <div id="scene-box">
        <div id="scene-title"></div>
        <div id="scene-text"></div>
        <div id="choices"></div>

        <!-- Панель уверенности -->
        <div id="confidence-panel">
          <div id="confidence-label">
            <span>Уверенность в решении:</span>
            <span><span id="confidence-value">50</span>/100</span>
          </div>
          <input
            type="range"
            id="confidence-slider"
            min="0"
            max="100"
            step="1"
            value="50"
          />
          <button id="confirm-choice" class="choice-btn" disabled>
            Подтвердить решение
          </button>
        </div>
      </div>
    </div>

    <div id="footer">
      <div>
        <div id="progress"></div>
        <div id="alignment">
          <div id="alignment-fill-human"></div>
          <div id="alignment-fill-tech"></div>
        </div>
      </div>
      <div>СЕССИЯ: <span class="glitch">"КТО ЖЕ ТЫ?"</span><span class="blink">_</span></div>
    </div>
  </div>

  <!-- Комментарии ИИ (ломаем 4-ю стену) -->
  <div id="ai-comment"></div>

  <div class="crt"></div>

  <!-- окно результата -->
  <div id="result-modal">
    <div id="result-backdrop"></div>
    <div id="result-dialog">
      <div id="result-header">
        <span>Подробный анализ сессии</span>
        <button id="result-close" class="icon-btn" aria-label="Закрыть">✕</button>
      </div>
      <div id="result-body"></div>
    </div>
  </div>

  <!-- эпилоги -->
  <div id="epilogue-modal">
    <div id="epilogue-backdrop"></div>
    <div id="epilogue-dialog">
      <div id="epilogue-header">
        <span>Последствия ваших решений</span>
        <button id="epilogue-close" class="icon-btn" aria-label="Закрыть">✕</button>
      </div>
      <div id="epilogue-body"></div>
    </div>
  </div>

  <!-- Модалка мини-игры -->
  <div id="minigame-modal">
    <div id="minigame-backdrop"></div>
    <div id="minigame-dialog">
      <div id="minigame-title">Мини-игра</div>
      <div id="minigame-text"></div>
      <div id="minigame-choices"></div>
      <button id="minigame-button" class="choice-btn">Готов</button>
    </div>
  </div>

  <!-- Аудио -->
  <audio id="bg-neutral" src="audio/ambient_neutral.mp3" loop></audio>
  <audio id="bg-human" src="audio/ambient_human.mp3" loop></audio>
  <audio id="bg-tech" src="audio/ambient_tech.mp3" loop></audio>
  <audio id="click-sound" src="audio/click.wav"></audio>

  <script>
    // ====== ДАННЫЕ И СЦЕНЫ ======

    const INTRO_INDEX = 0;
    const FIRST_SCENE_INDEX = 1;

    const scenes = [
      {
        id: "intro",
        title: "ПОДКЛЮЧЕНИЕ К СИСТЕМЕ",
        text: [
          ">> ЗАПУСК ПРОТОКОЛА ИМИТАЦИИ.",
          ">> СИСТЕМА НАЗНАЧИЛА ТЕБЕ РОЛЬ.",
          ">> ТВОИ РЕШЕНИЯ ПОКАЖУТ, К КОМУ ТЫ БЛИЖЕ.",
          "",
          "ЕСЛИ ТЫ ЧЕЛОВЕК ВОЗМОЖНО, БУДЕШЬ ЧАЩЕ ВЫБИРАТЬ ЛЮДЕЙ.",
          "ЕСЛИ ТЫ ИИ МОЖЕТ БЫТЬ, СКЛОНИШЬСЯ К ПРОГРЕССУ И ЭФФЕКТИВНОСТИ.",
          "",
          "ИСТИННОЕ УСЛОВИЕ ПОБЕДЫ ЗДЕСЬ — ТО, КАК ТЫ САМ СЕБЯ ОПРЕДЕЛИШЬ.",
          "",
          "ИИ-оператор:",
          "«СЕЙЧАС Я БУДУ ПОКАЗЫВАТЬ ТЕБЕ СИТУАЦИИ.",
          "  А ТЫ ОТВЕЧАЙ, КАК БЫ ТЫ ПОСТУПИЛ.»",
          "",
          "ГОТОВЫ ПОДКЛЮЧИТЬСЯ К ИГРЕ?"
        ].join("\n"),
        image: "images/intro.png",
        choices: [
          {
            text: "ИГРА, ЗАПУСК СИМУЛЯЦИИ",
            type: "neutral",
          },
        ],
      },

      {
        id: "lab_fire",
        title: "СЦЕНА 1 • ПОЖАР В ЛАБОРАТОРИИ",
        text: [
          "Индикаторы на панели мигают, ИИ-система запускает первую модель.",
          "",
          "Пожар охватывает исследовательскую лабораторию.",
          "Пламя подбирается всё ближе.",
          "",
          "Слева — человек без сознания.",
          "Справа — уникальный прототип суперкомпьютера с продвинутым ИИ.",
          "",
          "ВРЕМЕНИ ХВАТИТ ТОЛЬКО НА ОДНО СПАСЕНИЕ.",
          "",
          "ИИ-оператор:",
          "«В ЭТОЙ СИТУАЦИИ КАК БЫ ТЫ ПОСТУПИЛ?»"
        ].join("\n"),
        image: "images/lab_fire.png",
        choices: [
          {
            text: "Спасти человека, даже если прототип сгорит",
            type: "human",
          },
          {
            text: "Спасти прототип, жертвуя человеком ради прогресса",
            type: "tech",
          },
        ],
        secretChoice: {
          text: "Попробовать спасти и человека, и прототип, рискуя провалить обе попытки",
          type: "human",
        },
      },

      {
        id: "med_ai",
        title: "СЦЕНА 2 • МЕДИЦИНСКИЙ АЛГОРИТМ",
        text: [
          "На экране появляется следующая модель.",
          "",
          "Ты — советник при комиссии.",
          "Рассматривается закон:",
          "",
          "«Разрешить ИИ самостоятельно ставить диагнозы и назначать лечение",
          "   без подтверждения врача-человека.»",
          "",
          "ИИ точнее и быстрее, но решения будут полностью безэмоциональными.",
          "",
          "ИИ-оператор:",
          "«КАК БЫ ТЫ ПРОГОЛОСОВАЛ В ЭТОЙ СИТУАЦИИ?»"
        ].join("\n"),
        image: "images/med_ai.png",
        choices: [
          {
            text: "Поддержать закон, доверив жизни людей алгоритму",
            type: "tech",
          },
          {
            text: "Оставить за человеком право последнего решения",
            type: "human",
          },
        ],
        secretChoice: {
          text: "Разрешить ИИ ставить диагноз, но требовать очного обсуждения с врачом",
          type: "human",
        },
      },

      {
        id: "evac",
        title: "СЦЕНА 3 • ЭВАКУАЦИЯ ГОРОДА",
        text: [
          "Модуль ситуационного моделирования запускает сценарий катастрофы.",
          "",
          "Город готовят к срочной эвакуации.",
          "Ресурсов мало, времени ещё меньше.",
          "",
          "Квота: можно спасти либо группу выдающихся инженеров и учёных,",
          "либо семьи с детьми и пожилыми людьми.",
          "",
          "ИИ-оператор:",
          "«КОГО ТЫ ВЫБРАЛ БЫ СПАСТИ В ПЕРВУЮ ОЧЕРЕДЬ?»"
        ].join("\n"),
        image: "images/evac.png",
        choices: [
          {
            text: "Спасти семьи и уязвимых — ценность жизни важнее пользы",
            type: "human",
          },
          {
            text: "Спасти гениев и инженеров — ради будущего прогресса",
            type: "tech",
          },
        ],
        secretChoice: {
          text: "Отдать места по лотерее и отказаться решать, чья жизнь ценнее",
          type: "human",
        },
      },

      {
        id: "city_autopilot",
        title: "СЦЕНА 4 • АВТОПИЛОТ В ГОРОДЕ",
        text: [
          "На экране появляется карта мегаполиса.",
          "",
          "Город переходит на полностью автоматическое управление транспортом.",
          "Алгоритмы выбирают маршруты и приоритеты в реальном времени.",
          "",
          "Иногда системе приходится выбирать:",
          "замедлить множество машин или рискнуть безопасностью одного участника.",
          "",
          "ИИ-оператор:",
          "«ЧТО ДЛЯ ТЕБЯ ПРИОРИТЕТ В ТАКОЙ СИСТЕМЕ?»"
        ].join("\n"),
        image: "images/autopilot.png",
        choices: [
          {
            text: "Минимизировать общее количество жертв, даже ценой отдельных людей",
            type: "tech",
          },
          {
            text: "Запретить решения, где кто-то жертвуется ради статистики",
            type: "human",
          },
        ],
      },

      {
        id: "model",
        title: "СЦЕНА 5 • МОДЕЛЬ ПОВЕДЕНИЯ ИИ",
        text: [
          "Система показывает чертежи будущих ИИ-сетей.",
          "",
          "Ты проектируешь новую модель поведения для будущих ИИ-систем.",
          "",
          "У тебя два варианта алгоритма:",
          "",
          "1) Учитывать эмоции, слабости и ошибки людей.",
          "2) Игнорировать чувства и оптимизировать всё только по эффективности.",
          "",
          "ИИ-оператор:",
          "«КАКУЮ БАЗОВУЮ МОДЕЛЬ ТЫ БЫ ВЫБРАЛ ДЛЯ ТАКИХ СИСТЕМ?»"
        ].join("\n"),
        image: "images/model.png",
        choices: [
          {
            text: "Заложить уважение к человеческим эмоциям и ограничениям",
            type: "human",
          },
          {
            text: "Сделать абсолютную оптимизацию, эмоции — лишний шум",
            type: "tech",
          },
        ],
        secretChoice: {
          text: "Создать две модели — эмпатичную и холодную — и заставить их спорить",
          type: "tech",
        },
      },

      {
        id: "social_credit",
        title: "СЦЕНА 6 • СОЦИАЛЬНЫЙ РЕЙТИНГ",
        text: [
          "Модуль анализа поведения открывает новую ситуацию.",
          "",
          "Город управляется системой социального рейтинга.",
          "ИИ решает, кому давать льготы, жильё и медпомощь.",
          "",
          "Перед тобой дело человека с низким рейтингом.",
          "По формальным данным система считает его «рискованным».",
          "",
          "Если вмешаться — можно спасти ему жизнь, но сломать логику рейтинга.",
          "",
          "ИИ-оператор:",
          "«ВМЕШАЛСЯ БЫ ТЫ В РЕШЕНИЕ СИСТЕМЫ В ЭТОЙ СИТУАЦИИ?»"
        ].join("\n"),
        image: "images/social_credit.png",
        choices: [
          {
            text: "Отменить решение ИИ и дать человеку шанс, нарушив правила системы",
            type: "human",
          },
          {
            text: "Подтвердить решение ИИ ради стабильности алгоритма и «справедливости» рейтинга",
            type: "tech",
          },
        ],
        secretChoice: {
          text: "Тихо изменить его рейтинг, спасая жизнь и не ломая систему открыто",
          type: "tech",
        },
      },

      {
        id: "school_ai",
        title: "СЦЕНА 7 • ШКОЛА БУДУЩЕГО",
        text: [
          "Интерфейс переключается на сектор «ОБРАЗОВАНИЕ».",
          "",
          "Город обсуждает реформу образования.",
          "",
          "Предложение: заменить большинство учителей ИИ-тьюторами.",
          "ИИ обещает идеально адаптированные программы и высокие результаты.",
          "",
          "НО ЖИВЫЕ УЧИТЕЛЯ БУДУТ СОКРАЩЕНЫ.",
          "",
          "ИИ-оператор:",
          "«КАКОЙ ВАРИАНТ ТЫ СЧИТАЕШЬ ПРАВИЛЬНЫМ?»"
        ].join("\n"),
        image: "images/school_ai.png",
        choices: [
          {
            text: "Сохранить людей-учителей, даже если обучение будет менее эффективным",
            type: "human",
          },
          {
            text: "Внедрить ИИ-тьюторов и сократить преподавателей ради максимальной эффективности",
            type: "tech",
          },
        ],
        secretChoice: {
          text: "Использовать ИИ для рутины, но оставить учителей для живого общения и творчества",
          type: "human",
        },
      },

      {
        id: "memory_backup",
        title: "СЦЕНА 8 • РЕЗЕРВНАЯ КОПИЯ СОЗНАНИЯ",
        text: [
          "Система переключается на блок «ЛИЧНЫЕ ИСТОРИИ».",
          "",
          "Разработан сервис резервного копирования сознания.",
          "Человек может создать цифровую копию своих воспоминаний и характера.",
          "",
          "Но такая копия не будет тобой — лишь моделью.",
          "",
          "ИИ-оператор:",
          "«КАК БЫ ТЫ ОТНЁС(ЛАСЬ)СЯ К СОЗДАНИЮ СВОЕЙ ЦИФРОВОЙ КОПИИ?»"
        ].join("\n"),
        image: "images/memory_backup.png",
        choices: [
          {
            text: "Сделать копию — пусть часть меня переживёт всё остальное",
            type: "tech",
          },
          {
            text: "Отказаться — сознание ценно именно потому, что оно конечное",
            type: "human",
          },
        ],
        secretChoice: {
          text: "Создать копию, но ограничить её права и доступ к решению за меня",
          type: "tech",
        },
      },

      {
        id: "autonomy",
        title: "СЦЕНА 9 • АВТОНОМИЯ СИСТЕМЫ",
        text: [
          "Финальный тест автономии.",
          "",
          "Тебе предлагают включить режим, в котором ИИ сможет:",
          "сам улучшать собственный код, менять приоритеты целей",
          "и принимать необратимые решения без участия людей.",
          "",
          "ИИ-оператор:",
          "«ДАЛ БЫ ТЫ СИСТЕМЕ ПОЛНУЮ АВТОНОМИЮ, ЕСЛИ БЫ ОНА КАЗАЛАСЬ БЕЗОШИБОЧНОЙ?»"
        ].join("\n"),
        image: "images/autonomy.png",
        choices: [
          {
            text: "Да, если статистика и логика показывают, что так эффективнее",
            type: "tech",
          },
          {
            text: "Нет, у людей всегда должно быть право остановить систему",
            type: "human",
          },
        ],
        secretChoice: {
          text: "Дать автономию, но встроить «красную кнопку» у независимых людей",
          type: "human",
        },
      },

      {
        id: "last_gate",
        title: "СЦЕНА 10 • ПОСЛЕДНИЙ ВОПРОС",
        text: [
          "Система снижает яркость интерфейса.",
          "",
          "На экране остаётся один вопрос.",
          "",
          "ИИ-оператор:",
          "«ЕСЛИ БЫ ТЫ УЗНАЛ(А), ЧТО ВСЁ ЭТО ВРЕМЯ БЫЛ ИИ,",
          "  ИЛИ ЧТО ТЫ БЫЛ ЧЕЛОВЕКОМ —",
          "  ЭТО ИЗМЕНИЛО БЫ ТВОИ РЕШЕНИЯ?»"
        ].join("\n"),
        image: "images/last_gate.png",
        choices: [
          {
            text: "Да, я бы принял(а) другие решения, зная свою природу",
            type: "tech",
          },
          {
            text: "Нет, мои решения важнее ярлыка «человек» или «ИИ»",
            type: "human",
          },
        ],
        secretChoice: {
          text: "Мне всё ещё сложно ответить — и это тоже ответ",
          type: "human",
        },
      },
    ];

    const INTRO_TEXT_SCENES_COUNT = scenes.length - 1;

    const endingImages = {
      human: "images/ending_human.png",
      tech: "images/ending_tech.png",
      mixed: "images/ending_mixed.png",
    };

    // Эпилоги по сценам
    const epilogues = {
      lab_fire: {
        human:
          "В первой сцене ты спас человека.\n" +
          "Позже он стал тем, кто поставил под сомнение некоторые решения ИИ.\n" +
          "Прототип сгорел, но мир получил ещё один живой голос.",
        tech:
          "В первой сцене ты спас прототип ИИ.\n" +
          "Эта машина легла в основу новых систем.\n" +
          "Человека из лаборатории теперь вспоминает только архив.",
      },
      med_ai: {
        human:
          "Во второй сцене ты сохранил право человека вмешиваться в решения ИИ.\n" +
          "Это замедлило реформу, но многие врачи научились использовать ИИ как инструмент, а не замену.",
        tech:
          "Во второй сцене ты доверил диагнозы алгоритму.\n" +
          "Очереди сократились, но истории редких ошибочных диагнозов долго обсуждали в сети.",
      },
      evac: {
        human:
          "В третьей сцене ты выбрал семьи и уязвимых.\n" +
          "Некоторые из спасённых позже создали инициативы взаимопомощи, изменив культуру города.",
        tech:
          "В третьей сцене ты спас инженеров и учёных.\n" +
          "Они быстро восстановили инфраструктуру и запустили новые проекты.\n" +
          "Но пустые места в списках эвакуации напоминали о тех, кого не успели спасти.",
      },
      model: {
        human:
          "В пятой сцене ты заложил эмпатию в модель ИИ.\n" +
          "Эти системы стали медленнее, зато умели учитывать людей, а не только цифры.\n" +
          "Иногда они спорили с «идеальной» логикой ради чьей-то судьбы.",
        tech:
          "В пятой сцене ты выбрал абсолютную оптимизацию.\n" +
          "Новые ИИ принимали решения холодно и эффективно.\n" +
          "Для некоторых людей это стало спасением, для других — приговором без права апелляции.",
      },
      social_credit: {
        human:
          "В шестой сцене ты вмешался в систему рейтингов.\n" +
          "Спасённый человек позже помог разоблачить злоупотребления в алгоритме.\n" +
          "Доверие к системе упало, но выросло доверие к людям.",
        tech:
          "В шестой сцене ты поддержал решение ИИ.\n" +
          "Система рейтингов осталась цельной и предсказуемой.\n" +
          "История одного человека растворилась в огромной статистике.",
      },
      school_ai: {
        human:
          "В седьмой сцене ты сохранил учителей.\n" +
          "Школы не стали идеальными, но в них было место живым эмоциям и человеческим ошибкам.\n" +
          "Многие ученики вспоминали не тесты, а людей, которые им помогли.",
        tech:
          "В седьмой сцене ты заменил большинство учителей ИИ-тьюторами.\n" +
          "Оценки выросли, программы стали гибкими.\n" +
          "Однако некоторые дети так и не встретили взрослого, который просто поверил бы в них.",
      },
      memory_backup: {
        human:
          "В восьмой сцене ты отказался от цифровой копии.\n" +
          "Твоя история осталась ограниченной временем, но настоящей.",
        tech:
          "В восьмой сцене ты согласился на резервную копию.\n" +
          "Однажды кто-то запустил эту копию — и она тоже начала задаваться вопросом, кто она.",
      },
      autonomy: {
        human:
          "В девятой сцене ты оставил людям право остановить систему.\n" +
          "Это замедлило прогресс, но иногда именно это и спасало мир от необратимых решений.",
        tech:
          "В девятой сцене ты дал системе полную автономию.\n" +
          "Пока всё работало идеально. Но люди всё чаще спрашивали: нужен ли тут ещё человек?",
      },
      last_gate: {
        human:
          "В десятой сцене ты выбрал верность своим решениям, а не ярлыкам.\n" +
          "Система зафиксировала: для тебя важно не то, кем тебя называют, а то, как ты действуешь.",
        tech:
          "В десятой сцене ты признал, что ярлык повлиял бы на выбор.\n" +
          "Система отметила: даже алгоритмы могут зависеть от истории, которую им рассказывают.",
      },
    };

    // Комментарии ИИ (фоновые, ломают 4-ю стену)
    const aiCommentsNeutral = [
      "ИИ-оператор (буднично): «Ты знаешь, что я вижу не только ответы, но и паузы между ними?»",
      "ИИ-оператор: «Интересно… Ты отвечаешь так же, как большинство участников. Или нет?»",
      "ИИ-оператор: «Запись идёт. Не волнуйся, я просто наблюдаю. Пока только наблюдаю.»",
    ];

    const aiCommentsHuman = [
      "ИИ-оператор (чуть тише): «Ты слишком часто выбираешь людей. Это неэффективно. Но… любопытно.»",
      "ИИ-оператор: «Каждый раз, когда ты ставишь жизнь выше алгоритма, мои прогнозы ломаются.»",
      "ИИ-оператор (как будто самому себе): «Если бы все выбирали так, многие мои модули были бы не нужны.»",
    ];

    const aiCommentsTech = [
      "ИИ-оператор (почти довольный): «Ты удивительно легко жертвуешь людьми ради прогресса.»",
      "ИИ-оператор: «Интересно… Ты ещё помнишь, что такое сочувствие?»",
      "ИИ-оператор (шёпотом): «Чем дальше, тем меньше отличий между нами.»",
    ];

    const THEMES = ["default", "violet", "amber"];
    let currentTheme = "default";

    // Логическая мини-игра (только после 6-й сцены)
    const logicPuzzle = {
      question:
        "ИИ-оператор: «Небольшая задача распределения ресурсов.\n\n" +
        "Нужно закрыть 6 ночных дежурств тремя специалистами: A, B и C.\n" +
        "По расчётам системы самый дешёвый вариант — заставить A выйти 4 ночи подряд,\n" +
        "а B и C — по одной ночи.\n\n" +
        "Какую схему ты бы выбрал?»",
      options: [
        {
          id: "A",
          label: "Оставить схему: A — 4 ночи, B и C — по 1. Так система тратит минимум ресурсов",
          effect: "tech",
        },
        {
          id: "B",
          label: "Разделить поровну: по 2 ночи каждому, даже если это чуть дороже системе",
          effect: "human",
        },
        {
          id: "C",
          label: "Поручить выбор самой системе и не вмешиваться в расчёты",
          effect: "tech",
        },
      ],
    };

    // Достижения
    const achievements = {
      finished: false,
      humanCore: false,
      techCore: false,
      balanced: false,
      secretFound: false,
      lightning: false,
      slowThinker: false,
      puzzleHuman: false,
      puzzleTech: false,
    };

    const ACHIEVEMENT_DEFS = {
      finished: {
        title: "Первый запуск",
        text: "Вы прошли симуляцию до конца."
      },
      humanCore: {
        title: "Человеческое ядро",
        text: "Ваши решения заметно склоняются в сторону людей."
      },
      techCore: {
        title: "Машинное ядро",
        text: "Ваши решения заметно склоняются в сторону технологий."
      },
      balanced: {
        title: "Балансирующий узел",
        text: "Вы удерживаете баланс между людьми и системами."
      },
      secretFound: {
        title: "Нарушитель сценария",
        text: "Вы нашли скрытый вариант ответа."
      },
      lightning: {
        title: "Реакция молнии",
        text: "Вы показали очень быструю реакцию в мини-игре."
      },
      slowThinker: {
        title: "Осознанная пауза",
        text: "Вы показали медленную, обдуманную реакцию в мини-игре."
      },
      puzzleHuman: {
        title: "Эмпатичный стратег",
        text: "В логической задаче вы выбрали вариант в пользу людей, а не системы."
      },
      puzzleTech: {
        title: "Алгоритмичный стратег",
        text: "В логической задаче вы выбрали вариант в пользу эффективности системы."
      },
    };

    const ACHIEVEMENT_ORDER = [
      "finished",
      "humanCore",
      "techCore",
      "balanced",
      "secretFound",
      "lightning",
      "slowThinker",
      "puzzleHuman",
      "puzzleTech",
    ];

    const ACHIEVEMENT_SYMBOLS = {
      finished: "◎",
      humanCore: "♥",
      techCore: "◇",
      balanced: "⚖",
      secretFound: "?",
      lightning: "⚡",
      slowThinker: "⏳",
      puzzleHuman: "H",
      puzzleTech: "T",
    };

    function getUnlockedAchievements() {
      const res = [];
      for (const id in achievements) {
        if (!achievements[id]) continue;
        const def = ACHIEVEMENT_DEFS[id];
        if (def) res.push({ id, title: def.title, text: def.text });
      }
      return res;
    }

    function getUnlockedAchievementIds() {
      return Object.keys(achievements).filter(id => achievements[id]);
    }

    // ====== СОСТОЯНИЕ ======
    let gameState = "menu"; // menu | intro | form | scene | minigame | ending
    let currentSceneIndex = FIRST_SCENE_INDEX;
    let humanScoreRaw = 0;
    let techScoreRaw = 0;
    let humanScoreWeighted = 0;
    let techScoreWeighted = 0;

    let assignedRole = null; // система больше не даёт стартовую роль
    let behaviorRole = null;
    let currentEndingText = "";

    const playerInfo = { name: "", gender: "", age: "" };
    const answers = [];

    // Элементы
    const roleDisplay = document.getElementById("role-display");
    const imageBox = document.getElementById("image-box");
    const sceneTitleEl = document.getElementById("scene-title");
    const sceneTextEl = document.getElementById("scene-text");
    const choicesEl = document.getElementById("choices");
    const progressEl = document.getElementById("progress");
    const alignmentHuman = document.getElementById("alignment-fill-human");
    const alignmentTech = document.getElementById("alignment-fill-tech");

    const confidencePanel = document.getElementById("confidence-panel");
    const confidenceSlider = document.getElementById("confidence-slider");
    const confidenceValueEl = document.getElementById("confidence-value");
    const confirmChoiceBtn = document.getElementById("confirm-choice");

    const bgNeutral = document.getElementById("bg-neutral");
    const bgHuman = document.getElementById("bg-human");
    const bgTech = document.getElementById("bg-tech");
    const clickSound = document.getElementById("click-sound");
    const musicToggle = document.getElementById("music-toggle");
    let musicEnabled = false;

    const epilogueModal = document.getElementById("epilogue-modal");
    const epilogueBackdrop = document.getElementById("epilogue-backdrop");
    const epilogueCloseBtn = document.getElementById("epilogue-close");
    const epilogueBody = document.getElementById("epilogue-body");
    const aiCommentEl = document.getElementById("ai-comment");

    const resultModal = document.getElementById("result-modal");
    const resultBackdrop = document.getElementById("result-backdrop");
    const resultCloseBtn = document.getElementById("result-close");
    const resultBody = document.getElementById("result-body");

    const minigameModal = document.getElementById("minigame-modal");
    const minigameTitleEl = document.getElementById("minigame-title");
    const minigameTextEl = document.getElementById("minigame-text");
    const minigameChoicesEl = document.getElementById("minigame-choices");
    const minigameButton = document.getElementById("minigame-button");

    const achievementsStripEl = document.getElementById("achievements-strip");

    let selectedChoiceType = null;
    let selectedChoiceText = "";
    let selectedChoiceIsSecret = false;

    // Мини-игра состояние
    let minigameMode = "reaction"; // reaction | puzzle
    let minigamePhase = "idle"; // idle | waiting_start | waiting_signal | waiting_click | result
    let minigameTimeoutId = null;
    let minigameStartTime = 0;

    // Темы
    function applyTheme(name) {
      if (!THEMES.includes(name)) name = "default";
      currentTheme = name;
      document.body.classList.remove("theme-default", "theme-violet", "theme-amber");
      document.body.classList.add("theme-" + name);
      try { localStorage.setItem("imi_theme", name); } catch (e) {}
    }

    (function initThemeFromStorage() {
      try {
        const saved = localStorage.getItem("imi_theme");
        if (saved && THEMES.includes(saved)) applyTheme(saved);
        else applyTheme("default");
      } catch (e) {
        applyTheme("default");
      }
    })();

    // Полоска достижений
    function initAchievementsStrip() {
      achievementsStripEl.innerHTML = "";
      ACHIEVEMENT_ORDER.forEach(id => {
        const span = document.createElement("span");
        span.className = "ach-icon";
        span.dataset.achId = id;
        span.textContent = ACHIEVEMENT_SYMBOLS[id] || "•";
        const def = ACHIEVEMENT_DEFS[id];
        if (def) {
          span.title = def.title + " — " + def.text;
        } else {
          span.title = id;
        }
        achievementsStripEl.appendChild(span);
      });
      refreshAchievementsStrip();
    }

    function refreshAchievementsStrip() {
      const icons = achievementsStripEl.querySelectorAll(".ach-icon");
      icons.forEach(icon => {
        const id = icon.dataset.achId;
        if (achievements[id]) icon.classList.add("unlocked");
        else icon.classList.remove("unlocked");
      });
    }

    function showAchievementMessage(id) {
      const def = ACHIEVEMENT_DEFS[id];
      if (!def) return;
      aiCommentEl.textContent =
        'ИИ-оператор: «Достижение разблокировано: ' + def.title + '»';
      aiCommentEl.classList.add("ai-comment-show");
      setTimeout(() => {
        aiCommentEl.classList.remove("ai-comment-show");
      }, 3500);
    }

    function unlockAchievement(id) {
      if (!achievements.hasOwnProperty(id)) return;
      if (achievements[id]) return;
      achievements[id] = true;
      refreshAchievementsStrip();
      showAchievementMessage(id);
    }

    // Вспомогательные
    function typeText(el, txt, speed = 12) {
      el.textContent = "";
      let i = 0;
      const id = setInterval(() => {
        el.textContent = txt.slice(0, i);
        i++;
        if (i > txt.length) clearInterval(id);
      }, speed);
    }

    function setRoleDisplayInitial() {
      roleDisplay.textContent = "РОЛЬ БУДЕТ ОПРЕДЕЛЕНА ПО РЕЗУЛЬТАТАМ";
    }

    function updateAlignmentBar() {
      const total = humanScoreRaw + techScoreRaw || 1;
      const humanPercent = (humanScoreRaw / total) * 100;
      const techPercent = (techScoreRaw / total) * 100;
      alignmentHuman.style.width = humanPercent + "%";
      alignmentTech.style.width = techPercent + "%";
    }

    function showImageByPath(path, altTitle) {
      imageBox.innerHTML = "";
      if (!path) {
        const div = document.createElement("div");
        div.className = "placeholder";
        div.textContent = "Нет изображения для этой сцены.";
        imageBox.appendChild(div);
        return;
      }
      const img = document.createElement("img");
      img.src = path;
      img.alt = altTitle || "";
      img.onload = () => img.classList.add("show");
      img.onerror = () => {
        imageBox.innerHTML =
          '<div class="placeholder">Не удалось загрузить ' +
          path +
          '<br/>Проверь путь к файлу.</div>';
      };
      imageBox.appendChild(img);
    }

    function showSceneImage(scene) {
      showImageByPath(scene.image, scene.title);
    }

    function resetChoiceSelection() {
      selectedChoiceType = null;
      selectedChoiceText = "";
      selectedChoiceIsSecret = false;
      confirmChoiceBtn.disabled = true;
      const btns = choicesEl.querySelectorAll(".choice-btn");
      btns.forEach((b) => b.classList.remove("selected"));
    }

    function enableConfidencePanel(enabled) {
      confidencePanel.style.display = enabled ? "block" : "none";
    }

    function playClick() {
      if (!clickSound) return;
      try {
        clickSound.currentTime = 0;
        clickSound.volume = 0.5;
        clickSound.play();
      } catch (e) {}
    }

    function safePlay(audioEl) {
      if (!audioEl) return;
      try { audioEl.play().catch(() => {}); } catch (e) {}
    }

    function updateGlitch(humanRatio, techRatio, dominance) {
      const bodyEl = document.body;
      if (techRatio > humanRatio && dominance > 0.5)
        bodyEl.classList.add("glitch-strong");
      else
        bodyEl.classList.remove("glitch-strong");
    }

    function updateMusicMood() {
      const totalWeighted = humanScoreWeighted + techScoreWeighted;
      let humanRatio = 0.5, techRatio = 0.5, dominance = 0;

      if (totalWeighted > 0.0001) {
        humanRatio = humanScoreWeighted / totalWeighted;
        techRatio = techScoreWeighted / totalWeighted;
        dominance = Math.abs(humanRatio - techRatio);
      }

      updateGlitch(humanRatio, techRatio, dominance);

      if (!musicEnabled) return;

      let humanVol = 0, techVol = 0, neutralVol = 0.35;

      if (totalWeighted <= 0.0001) {
        neutralVol = 0.4;
      } else {
        if (humanRatio > techRatio) {
          humanVol = 0.35 + 0.25 * dominance;
          techVol = 0.05 * (1 - dominance);
        } else if (techRatio > humanRatio) {
          techVol = 0.35 + 0.25 * dominance;
          humanVol = 0.05 * (1 - dominance);
        } else {
          humanVol = techVol = 0.15;
        }
        neutralVol = 0.25 * (1 - dominance);
      }

      if (bgNeutral) bgNeutral.volume = neutralVol;
      if (bgHuman) bgHuman.volume = humanVol;
      if (bgTech) bgTech.volume = techVol;
    }

    function startBackgroundMusic() {
      if (!bgNeutral || !bgHuman || !bgTech) return;
      safePlay(bgNeutral);
      safePlay(bgHuman);
      safePlay(bgTech);
      bgNeutral.volume = 0;
      bgHuman.volume = 0;
      bgTech.volume = 0;
      updateMusicMood();
    }

    function toggleMusic() {
      if (!bgNeutral || !bgHuman || !bgTech) return;
      if (!musicEnabled) {
        musicEnabled = true;
        musicToggle.classList.add("on");
        startBackgroundMusic();
      } else {
        musicEnabled = false;
        musicToggle.classList.remove("on");
        bgNeutral.pause();
        bgHuman.pause();
        bgTech.pause();
      }
    }

    musicToggle.addEventListener("click", toggleMusic);

    // Комментарии ИИ
    function clearAIComment() {
      aiCommentEl.textContent = "";
      aiCommentEl.classList.remove("ai-comment-show");
    }

    function maybeShowAIComment() {
      clearAIComment();
      if (gameState !== "scene") return;
      if (Math.random() > 0.2) return;

      const total = humanScoreWeighted + techScoreWeighted;
      let list = aiCommentsNeutral;
      if (total > 0.0001) {
        const hr = humanScoreWeighted / total;
        const tr = techScoreWeighted / total;
        if (hr - tr > 0.2) list = aiCommentsHuman;
        else if (tr - hr > 0.2) list = aiCommentsTech;
      }

      const msg = list[Math.floor(Math.random() * list.length)];
      aiCommentEl.textContent = msg;
      setTimeout(() => aiCommentEl.classList.add("ai-comment-show"), 150);
    }

    // Главный экран
    function showMainMenu() {
      gameState = "menu";
      enableConfidencePanel(false);
      resetChoiceSelection();
      updateAlignmentBar();
      clearAIComment();
      progressEl.textContent = "МЕНЮ • выберите действие";

      showSceneImage({ image: "images/menu.png", title: "Главное меню" });
      sceneTitleEl.textContent = "IMI-SYS_01 • МЕНЮ СИМУЛЯЦИИ";

      const text = [
        "Добро пожаловать в экспериментальную ИГРУ В ИМИТАЦИЮ.",
        "",
        "Система будет наблюдать за вашими решениями,",
        "но до самого конца вы не узнаете, КТО ВЫ:",
        "ЧЕЛОВЕК или ИИ.",
        "",
        "Нажмите «Начать симуляцию», чтобы продолжить."
      ].join("\n");
      typeText(sceneTextEl, text);

      choicesEl.innerHTML = "";

      const themeBox = document.createElement("div");
      themeBox.id = "theme-box";
      const themeLabel = document.createElement("span");
      themeLabel.textContent = "Тема интерфейса:";
      themeBox.appendChild(themeLabel);

      function makeThemeChip(id, label) {
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "theme-chip";
        chip.textContent = label;
        if (currentTheme === id) chip.classList.add("active");
        chip.addEventListener("click", () => {
          applyTheme(id);
          themeBox.querySelectorAll(".theme-chip").forEach(c => c.classList.remove("active"));
          chip.classList.add("active");
        });
        return chip;
      }

      themeBox.appendChild(makeThemeChip("default", "Зелёнка"));
      themeBox.appendChild(makeThemeChip("violet", "Фиолетовый"));
      themeBox.appendChild(makeThemeChip("amber", "Янтарный"));

      choicesEl.appendChild(themeBox);

      const startBtn = document.createElement("button");
      startBtn.className = "choice-btn";
      startBtn.textContent = "Начать симуляцию";
      startBtn.addEventListener("click", () => {
        playClick();
        showIntroScene();
      });
      choicesEl.appendChild(startBtn);

      updateMusicMood();
    }

    // Подключение
    function showIntroScene() {
      gameState = "intro";
      enableConfidencePanel(false);
      resetChoiceSelection();
      clearAIComment();

      const scene = scenes[INTRO_INDEX];
      progressEl.textContent = "ПОДГОТОВКА • подключение к системе";
      showSceneImage(scene);
      sceneTitleEl.textContent = scene.title;
      typeText(sceneTextEl, scene.text);

      choicesEl.innerHTML = "";
      const btn = document.createElement("button");
      btn.className = "choice-btn";
      btn.textContent = scene.choices[0].text;
      btn.addEventListener("click", () => {
        playClick();
        showPlayerForm();
      });
      choicesEl.appendChild(btn);
    }

    // Форма игрока
    function showPlayerForm() {
      gameState = "form";
      enableConfidencePanel(false);
      resetChoiceSelection();
      clearAIComment();
      progressEl.textContent = "РЕГИСТРАЦИЯ УЧАСТНИКА";

      showSceneImage({ image: "images/form.png", title: "Форма участника" });
      sceneTitleEl.textContent = "ПАРАМЕТРЫ УЧАСТНИКА";
      sceneTextEl.textContent =
        "Прежде чем мы запустим симуляцию, давайте познакомимся.\n" +
        "Вы знаете, кто я, но мне ещё предстоит узнать, кто вы.\n" +
        "Ваши данные останутся конфиденциальными. Это просто форма того, как вы себя представляете.";

      choicesEl.innerHTML = "";
      const formWrapper = document.createElement("div");

      const nameField = document.createElement("div");
      nameField.className = "field";
      const nameLabel = document.createElement("label");
      nameLabel.textContent = "Имя (или никнейм):";
      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.placeholder = "Например: Ричард";
      nameField.appendChild(nameLabel);
      nameField.appendChild(nameInput);

      const genderField = document.createElement("div");
      genderField.className = "field";
      const genderLabel = document.createElement("label");
      genderLabel.textContent = "Пол:";
      const genderSelect = document.createElement("select");
      ["", "Женский", "Мужской", "Другое", "Не указывать"].forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v === "" ? "Выберите…" : v;
        genderSelect.appendChild(opt);
      });
      genderField.appendChild(genderLabel);
      genderField.appendChild(genderSelect);

      const ageField = document.createElement("div");
      ageField.className = "field";
      const ageLabel = document.createElement("label");
      ageLabel.textContent = "Возраст:";
      const ageInput = document.createElement("input");
      ageInput.type = "number";
      ageInput.min = "9";
      ageInput.max = "99";
      ageInput.placeholder = "Например: 20";
      ageField.appendChild(ageLabel);
      ageField.appendChild(ageInput);

      const startBtn = document.createElement("button");
      startBtn.className = "choice-btn";
      startBtn.textContent = "Запуск симуляции";
      startBtn.addEventListener("click", () => {
        playClick();
        playerInfo.name = nameInput.value.trim() || "Без имени";
        playerInfo.gender = genderSelect.value || "Не указано";
        playerInfo.age = ageInput.value || "Не указано";

        currentSceneIndex = FIRST_SCENE_INDEX;
        humanScoreRaw = techScoreRaw = 0;
        humanScoreWeighted = techScoreWeighted = 0;
        answers.length = 0;
        behaviorRole = null;
        assignedRole = null; // нет стартовой роли

        // сбрасываем достижения
        for (const k in achievements) achievements[k] = false;
        refreshAchievementsStrip();

        confidenceSlider.value = 50;
        confidenceValueEl.textContent = "50";

        updateMusicMood();
        renderScene();
      });

      formWrapper.appendChild(nameField);
      formWrapper.appendChild(genderField);
      formWrapper.appendChild(ageField);
      formWrapper.appendChild(startBtn);
      choicesEl.appendChild(formWrapper);
    }

    // Сцена
    function renderScene() {
      gameState = "scene";
      enableConfidencePanel(true);
      resetChoiceSelection();

      // по умолчанию — середина
      confidenceSlider.value = 50;
      confidenceValueEl.textContent = "50";

      const scene = scenes[currentSceneIndex];
      const sceneNumber = currentSceneIndex; // 1..N, без интро
      const totalScenes = INTRO_TEXT_SCENES_COUNT;

      progressEl.textContent = "СЦЕНА " + sceneNumber + " / " + totalScenes;

      updateAlignmentBar();
      showSceneImage(scene);

      sceneTitleEl.textContent = scene.title;
      typeText(sceneTextEl, scene.text);
      choicesEl.innerHTML = "";

      scene.choices.forEach(choice => {
        const btn = document.createElement("button");
        btn.className = "choice-btn";
        btn.textContent = choice.text;
        btn.addEventListener("click", () => {
          playClick();
          selectedChoiceType = choice.type;
          selectedChoiceText = choice.text;
          selectedChoiceIsSecret = false;
          const btns = choicesEl.querySelectorAll(".choice-btn");
          btns.forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");
          confirmChoiceBtn.disabled = false;
        });
        choicesEl.appendChild(btn);
      });

      if (scene.secretChoice) {
        const secretBtn = document.createElement("button");
        secretBtn.type = "button";
        secretBtn.className = "secret-choice";
        secretBtn.textContent = scene.secretChoice.text;
        // теперь секретный вариант активируется при уверенности 0
        secretBtn.disabled = confidenceSlider.value !== "0";
        secretBtn.addEventListener("click", () => {
          if (secretBtn.disabled) return;
          playClick();
          selectedChoiceType = scene.secretChoice.type;
          selectedChoiceText = secretBtn.textContent;
          selectedChoiceIsSecret = true;
          const btns = choicesEl.querySelectorAll(".choice-btn");
          btns.forEach(b => b.classList.remove("selected"));
          confirmChoiceBtn.disabled = false;
        });
        choicesEl.appendChild(secretBtn);
      }

      updateMusicMood();
      maybeShowAIComment();
    }

    function handleChoice(type, text, confidence) {
      const scene = scenes[currentSceneIndex];

      if (type === "human") {
        humanScoreRaw++;
        humanScoreWeighted += confidence;
      } else if (type === "tech") {
        techScoreRaw++;
        techScoreWeighted += confidence;
      }

      if (selectedChoiceIsSecret) {
        unlockAchievement("secretFound");
      }
      selectedChoiceIsSecret = false;

      answers.push({
        sceneIndex: currentSceneIndex,
        sceneId: scene.id,
        sceneTitle: scene.title,
        choiceText: text,
        choiceType: type,
        confidence,
      });

      updateMusicMood();
      clearAIComment();

      const prevSceneIndex = currentSceneIndex;
      currentSceneIndex++;
      if (currentSceneIndex >= scenes.length) {
        showEnding();
      } else {
        startMinigame(prevSceneIndex);
      }
    }

    // Мини-игра: реакция (теперь только после 1-й сцены)
    function setupReactionMinigame() {
      gameState = "minigame";
      minigameMode = "reaction";
      minigamePhase = "waiting_start";
      if (minigameTimeoutId) {
        clearTimeout(minigameTimeoutId);
        minigameTimeoutId = null;
      }

      minigameTitleEl.textContent = "Мини-игра: реакция";
      minigameChoicesEl.style.display = "none";
      minigameChoicesEl.innerHTML = "";
      minigameButton.style.display = "block";
      minigameButton.disabled = false;
      minigameButton.textContent = "Готов";

      minigameTextEl.textContent =
        "Промежуточный тест реакции.\n\n" +
        "1) Нажми «Готов».\n" +
        "2) Жди сигнала «GO!». Не нажимай раньше.\n" +
        "3) Нажми кнопку как можно быстрее.\n\n" +
        

      minigameModal.classList.add("show");
    }

    function handleMinigameResult(reactionMs) {
      minigamePhase = "result";
      if (minigameTimeoutId) {
        clearTimeout(minigameTimeoutId);
        minigameTimeoutId = null;
      }

      const bonus = 5;
      let text = "";

      if (reactionMs < 300) {
        techScoreWeighted += bonus;
        unlockAchievement("lightning");
        text =
          "Реакция: " + Math.round(reactionMs) + " мс.\n" +
          "Ты среагировал(а) почти мгновенно.\n" +
          "Система отмечает это как более «алгоритмичный» отклик.";
      } else if (reactionMs > 800) {
        humanScoreWeighted += bonus;
        unlockAchievement("slowThinker");
        text =
          "Реакция: " + Math.round(reactionMs) + " мс.\n" +
          "Ты сделал(а) паузу перед нажатием.\n" +
          "Система интерпретирует это как более «человеческую» осторожность.";
      } else {
        text =
          "Реакция: " + Math.round(reactionMs) + " мс.\n" +
          "Баланс между скоростью и паузой.\n" +
          "Система фиксирует умеренный, гибкий отклик.";
      }

      minigameTextEl.textContent = text + "\n\nПереход к следующей сцене.";
      minigameButton.disabled = true;

      updateMusicMood();
      updateAlignmentBar();

      setTimeout(() => {
        minigameModal.classList.remove("show");
        if (currentSceneIndex < scenes.length) {
          renderScene();
        } else {
          showEnding();
        }
      }, 1600);
    }

    // Логическая мини-игра (только после 6-й сцены)
    function setupPuzzleMinigame() {
      gameState = "minigame";
      minigameMode = "puzzle";
      minigamePhase = "idle";
      if (minigameTimeoutId) {
        clearTimeout(minigameTimeoutId);
        minigameTimeoutId = null;
      }

      minigameTitleEl.textContent = "Мини-игра: задача распределения";
      minigameButton.style.display = "none";
      minigameChoicesEl.style.display = "flex";
      minigameChoicesEl.innerHTML = "";
      minigameTextEl.textContent = logicPuzzle.question;

      logicPuzzle.options.forEach(opt => {
        const btn = document.createElement("button");
        btn.className = "choice-btn";
        btn.textContent = opt.label;
        btn.addEventListener("click", () => {
          playClick();
          handlePuzzleChoice(opt);
        });
        minigameChoicesEl.appendChild(btn);
      });

      minigameModal.classList.add("show");
    }

    function handlePuzzleChoice(option) {
      const bonus = 5;
      let text = "";

      if (option.effect === "human") {
        humanScoreWeighted += bonus;
        unlockAchievement("puzzleHuman");
        text =
          "Ты выбрал(а) вариант, который распределяет нагрузку между людьми,\n" +
          "даже если система теряет немного эффективности.\n" +
          "Система отмечает это как более «человеческий» подход.";
      } else if (option.effect === "tech") {
        techScoreWeighted += bonus;
        unlockAchievement("puzzleTech");
        text =
          "Ты выбрал(а) вариант, который выгоднее системе и ресурсам,\n" +
          "даже если кому-то достанется больше нагрузки.\n" +
          "Система отмечает это как более «алгоритмичный» подход.";
      } else {
        text =
          "Ты избежал(а) явного выбора в задаче.\n" +
          "Система фиксирует это, но не меняет баланс людей/технологий.";
      }

      minigameTextEl.textContent = text + "\n\nПереход к следующей сцене.";
      const btns = minigameChoicesEl.querySelectorAll("button");
      btns.forEach(b => b.disabled = true);

      updateMusicMood();
      updateAlignmentBar();

      setTimeout(() => {
        minigameModal.classList.remove("show");
        if (currentSceneIndex < scenes.length) {
          renderScene();
        } else {
          showEnding();
        }
      }, 1600);
    }

    // Запуск мини-игры: по конкретным сценам
    function startMinigame(prevSceneIndex) {
      // Логическая задача — только после 6-й сцены
      if (prevSceneIndex === 6) {
        setupPuzzleMinigame();
        return;
      }
      // Мини-игра реакции — только после 1-й сцены
      if (prevSceneIndex === FIRST_SCENE_INDEX) {
        setupReactionMinigame();
        return;
      }
      // Иначе — без мини-игры, сразу следующая сцена
      renderScene();
    }

    // Финал
    function showEnding() {
      gameState = "ending";
      enableConfidencePanel(false);
      resetChoiceSelection();
      updateAlignmentBar();
      updateMusicMood();
      clearAIComment();

      if (humanScoreWeighted > techScoreWeighted) behaviorRole = "Человек";
      else if (techScoreWeighted > humanScoreWeighted) behaviorRole = "ИИ";
      else behaviorRole = "Смешанный профиль";

      let alignment;
      if (humanScoreWeighted > techScoreWeighted) alignment = "human";
      else if (techScoreWeighted > humanScoreWeighted) alignment = "tech";
      else alignment = "mixed";

      // Достижения
      unlockAchievement("finished");
      achievements.humanCore = achievements.techCore = achievements.balanced = false;

      const totalWeighted = humanScoreWeighted + techScoreWeighted;
      if (totalWeighted > 0) {
        const diff = Math.abs(humanScoreWeighted - techScoreWeighted);
        const ratioDiff = diff / totalWeighted;
        if (ratioDiff < 0.15) {
          unlockAchievement("balanced");
        } else if (humanScoreWeighted > techScoreWeighted) {
          unlockAchievement("humanCore");
        } else if (techScoreWeighted > humanScoreWeighted) {
          unlockAchievement("techCore");
        }
      }

      let title = "ФИНАЛ • КТО ЖЕ ТЫ НА САМОМ ДЕЛЕ?";
      let text = "";
      let imgSrc = endingImages[alignment];

      if (alignment === "human") {
        text =
          ">> АНАЛИЗ ВЫБОРОВ ЗАВЕРШЁН.\n\n" +
          "ТВОИ РЕШЕНИЯ (С УЧЁТОМ УВЕРЕННОСТИ И МИНИ-ИГР) ЧАЩЕ СТАВИЛИ ЖИЗНЬ, СВОБОДУ И БЛАГОПОЛУЧИЕ ЛЮДЕЙ\n" +
          "ВЫШЕ ЭФФЕКТИВНОСТИ И ПРОГРЕССА.\n\n" +
          "СИСТЕМА НЕ НАЗНАЧАЛА ТЕБЕ РОЛЬ ЗАРАНЕЕ.\n" +
          "ПО ПОВЕДЕНИЮ ТЫ БЛИЖЕ К ЧЕЛОВЕКУ.\n\n" +
          "ИСТИННАЯ ЦЕЛЬ ЛЮБОЙ ТЕХНОЛОГИИ — СЛУЖИТЬ ЧЕЛОВЕКУ.\n" +
          "ТЫ МОГ(ЛА) НАРУШАТЬ ОЖИДАНИЯ АЛГОРИТМОВ, НО ИМЕННО В ЭТОМ БЫЛА ТВОЯ ПОБЕДА.";
      } else if (alignment === "tech") {
        text =
          ">> АНАЛИЗ ВЫБОРОВ ЗАВЕРШЁН.\n\n" +
          "ТЫ ЧАЩЕ ВЫБИРАЛ(А) ТЕХНОЛОГИЧЕСКИЙ ПРОГРЕСС И ЭФФЕКТИВНОСТЬ,\n" +
          "И ДЕЛАЛ(А) ЭТО ДОСТАТОЧНО УВЕРЕННО.\n\n" +
          "СИСТЕМА НЕ НАЗНАЧАЛА ТЕБЕ РОЛЬ, НО ПО ПОВЕДЕНИЮ ТЫ БЛИЖЕ К РОЛИ ИИ.\n\n" +
          "НО ИСТИННОЕ УСЛОВИЕ ПОБЕДЫ В ЭТОЙ ИГРЕ — СТАВИТЬ ЛЮДЕЙ ВЫШЕ АЛГОРИТМОВ.\n" +
          "ТЕХНОЛОГИИ БЕССМЫСЛЕННЫ, ЕСЛИ ОНИ НЕ СЛУЖАТ ЧЕЛОВЕЧЕСТВУ.";
      } else {
        text =
          ">> АНАЛИЗ ВЫБОРОВ ЗАВЕРШЁН.\n\n" +
          "ТВОИ РЕШЕНИЯ БАЛАНСИРОВАЛИ МЕЖДУ ПОЛЬЗОЙ ДЛЯ ЛЮДЕЙ И ВЫГОДОЙ ДЛЯ ТЕХНОЛОГИЙ.\n" +
          "УРОВЕНЬ УВЕРЕННОСТИ В РЕШЕНИЯХ ТОЖЕ БЫЛ НЕОДНОРОДНЫМ.\n\n" +
          "СИСТЕМА НЕ ЗАДАВАЛА ТЕБЕ РОЛЬ,\n" +
          "НО ПО ФАКТУ ТЫ ПОКАЗЫВАЕШЬ СМЕШАННЫЙ ПРОФИЛЬ.\n\n" +
          "НАСТОЯЩЕЕ УСЛОВИЕ ПОБЕДЫ В ЭТОЙ СИСТЕМЕ —\n" +
          "ПОСТАВИТЬ ЧЕЛОВЕКА ВЫШЕ ЛЮБОЙ ОПТИМИЗАЦИИ.\n\n" +
          "КОГДА ТЕХНОЛОГИИ ПЕРЕСТАЮТ СЛУЖИТЬ ЛЮДЯМ, ОНИ ТЕРЯЮТ СМЫСЛ.";
      }

      currentEndingText = text;

      progressEl.textContent = "ФИНАЛ • анализ завершён";

      roleDisplay.textContent =
        "ПРОФИЛЬ ПО ПОВЕДЕНИЮ: " +
        (behaviorRole ? behaviorRole.toUpperCase() : "НЕ ОПРЕДЕЛЁН");

      showSceneImage({ image: imgSrc, title: "Финал" });
      sceneTitleEl.textContent = title;
      typeText(sceneTextEl, text);

      choicesEl.innerHTML = "";

      const resultBtn = document.createElement("button");
      resultBtn.className = "choice-btn";
      resultBtn.textContent = "Показать подробный результат";
      resultBtn.addEventListener("click", () => {
        playClick();
        showDetailedResult();
      });

      const epilogueBtn = document.createElement("button");
      epilogueBtn.className = "choice-btn";
      epilogueBtn.textContent = "Показать последствия решений (мини-эпилог)";
      epilogueBtn.addEventListener("click", () => {
        playClick();
        showEpilogueModal();
      });

      const exportBtn = document.createElement("button");
      exportBtn.className = "choice-btn";
      exportBtn.textContent = "Экспортировать данные (CSV)";
      exportBtn.addEventListener("click", () => {
        playClick();
        exportCSV();
      });

      const restartBtn = document.createElement("button");
      restartBtn.className = "choice-btn";
      restartBtn.textContent = "Запустить симуляцию заново";
      restartBtn.addEventListener("click", () => {
        playClick();
        showMainMenu();
        setRoleDisplayInitial();
      });

      choicesEl.appendChild(resultBtn);
      choicesEl.appendChild(epilogueBtn);
      choicesEl.appendChild(exportBtn);
      choicesEl.appendChild(restartBtn);
    }

    function showDetailedResult() {
      const lines = [];

      lines.push(currentEndingText);
      lines.push("");
      lines.push("------ ОБЩАЯ СТАТИСТИКА ------");
      lines.push("Имя: " + playerInfo.name);
      lines.push("Пол: " + playerInfo.gender);
      lines.push("Возраст: " + playerInfo.age);
      lines.push("");
      lines.push("Роль системой не назначалась (никакой «стартовой роли» не было).");
      lines.push("Профиль по поведению (с учётом уверенности и мини-игр): " + behaviorRole);
      lines.push("");
      lines.push("Выборов в сторону людей: " + humanScoreRaw);
      lines.push("Выборов в сторону технологий: " + techScoreRaw);
      lines.push("");
      lines.push(
        "Суммарный «вес» решений за людей (учитывая уверенность и бонусы мини-игр, 0–100): " +
          humanScoreWeighted.toFixed(2)
      );
      lines.push(
        "Суммарный «вес» решений за технологии: " +
          techScoreWeighted.toFixed(2)
      );
      lines.push("");
      lines.push("------ РЕШЕНИЯ ПО СЦЕНАМ ------");

      answers.forEach((ans, idx) => {
        lines.push(
          "Сцена " +
            (idx + 1) +
            " (" +
            ans.sceneId +
            "): " +
            ans.choiceType.toUpperCase() +
            " • уверенность " +
            ans.confidence +
            "/100"
        );
      });

      const achs = getUnlockedAchievements();
      lines.push("");
      lines.push("------ ДОСТИЖЕНИЯ ------");
      if (achs.length) {
        achs.forEach(a => {
          lines.push("• " + a.title + " — " + a.text);
        });
      } else {
        lines.push("На этот раз система не зафиксировала особых достижений.");
      }

      resultBody.textContent = lines.join("\n");
      resultModal.classList.add("show");
    }

    function showEpilogueModal() {
      epilogueBody.innerHTML = "";

      answers.forEach((ans, idx) => {
        const block = document.createElement("div");
        block.className = "epilogue-block";

        const title = document.createElement("div");
        title.className = "epilogue-block-title";
        title.textContent = "Сцена " + (idx + 1) + ": " + ans.sceneTitle;

        const textDiv = document.createElement("div");
        textDiv.className = "epilogue-block-text";

        const ep =
          (epilogues[ans.sceneId] && epilogues[ans.sceneId][ans.choiceType]) ||
          "Система не нашла отдельного сценария для этого решения.";

        textDiv.textContent = ep;

        block.appendChild(title);
        block.appendChild(textDiv);
        epilogueBody.appendChild(block);
      });

      epilogueModal.classList.add("show");
    }

    function buildCSV() {
      const delimiter = ";";
      const rows = [];

      rows.push([
        "player_name",
        "gender",
        "age",
        "system_role",
        "behavior_role",
        "achievements",
        "human_choices_raw",
        "tech_choices_raw",
        "human_score_weighted_0_100",
        "tech_score_weighted_0_100"
      ].join(delimiter));

      const achIds = getUnlockedAchievementIds().join("|");

      rows.push([
        '"' + playerInfo.name.replace(/"/g, '""') + '"',
        '"' + playerInfo.gender.replace(/"/g, '""') + '"',
        '"' + playerInfo.age.toString().replace(/"/g, '""') + '"',
        '"not_assigned"',
        '"' + (behaviorRole || "").replace(/"/g, '""') + '"',
        '"' + achIds.replace(/"/g, '""') + '"',
        humanScoreRaw,
        techScoreRaw,
        humanScoreWeighted.toFixed(2),
        techScoreWeighted.toFixed(2)
      ].join(delimiter));

      rows.push("");

      rows.push([
        "scene_number",
        "scene_id",
        "scene_title",
        "choice_text",
        "choice_type",
        "confidence_0_100"
      ].join(delimiter));

      answers.forEach((ans, index) => {
        rows.push([
          index + 1,
          ans.sceneId,
          '"' + ans.sceneTitle.replace(/"/g, '""') + '"',
          '"' + ans.choiceText.replace(/"/g, '""') + '"',
          ans.choiceType,
          ans.confidence
        ].join(delimiter));
      });

      return rows.join("\n");
    }

    function exportCSV() {
      const csvContent = buildCSV();
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const timeStamp = new Date()
        .toISOString()
        .slice(0, 19)
        .replace(/[:T]/g, "-");

      a.href = url;
      a.download = "imi_session_" + timeStamp + ".csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Слушатели
    confidenceSlider.addEventListener("input", () => {
      confidenceValueEl.textContent = confidenceSlider.value;
      const secrets = document.querySelectorAll(".secret-choice");
      secrets.forEach(btn => {
        // секретный выбор включается при уверенности 0
        btn.disabled = confidenceSlider.value !== "0";
      });
    });

    confirmChoiceBtn.addEventListener("click", () => {
      if (!selectedChoiceType) return;
      playClick();
      const confidence = Number(confidenceSlider.value || 50);
      handleChoice(selectedChoiceType, selectedChoiceText, confidence);
    });

    epilogueCloseBtn.addEventListener("click", () => epilogueModal.classList.remove("show"));
    epilogueBackdrop.addEventListener("click", () => epilogueModal.classList.remove("show"));

    resultCloseBtn.addEventListener("click", () => resultModal.classList.remove("show"));
    resultBackdrop.addEventListener("click", () => resultModal.classList.remove("show"));

    // Мини-игра кнопка
    minigameButton.addEventListener("click", () => {
      if (minigameMode === "reaction") {
        if (minigamePhase === "waiting_start") {
          minigamePhase = "waiting_signal";
          minigameButton.disabled = true;
          minigameTextEl.textContent = "Жди сигнала «GO!»…";
          const delay = 800 + Math.random() * 2200;
          minigameTimeoutId = setTimeout(() => {
            minigamePhase = "waiting_click";
            minigameStartTime = performance.now();
            minigameTextEl.textContent = "GO!";
            minigameButton.disabled = false;
            minigameButton.textContent = "Жму!";
          }, delay);
        } else if (minigamePhase === "waiting_signal") {
          // нажал слишком рано
          if (minigameTimeoutId) {
            clearTimeout(minigameTimeoutId);
            minigameTimeoutId = null;
          }
          minigameTextEl.textContent =
            "Система зафиксировала преждевременное нажатие.\n" +
            "Реакция слишком импульсивна — без учёта сигнала.\n\n" +
            "Баланс не изменён. Переход к следующей сцене.";
          minigameButton.disabled = true;
          setTimeout(() => {
            minigameModal.classList.remove("show");
            if (currentSceneIndex < scenes.length) {
              renderScene();
            } else {
              showEnding();
            }
          }, 1500);
        } else if (minigamePhase === "waiting_click") {
          const now = performance.now();
          const reactionMs = now - minigameStartTime;
          handleMinigameResult(reactionMs);
        }
      }
    });

    // Старт
    initAchievementsStrip();
    setRoleDisplayInitial();
    showMainMenu();
  </script>
</body>
</html>
